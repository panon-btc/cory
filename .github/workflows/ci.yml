name: CI

on:
  push:
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2

      - name: Check Rust formatting
        run: cargo fmt --all -- --check

      - name: Run clippy with warnings denied
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  ui:
    name: UI
    runs-on: ubuntu-24.04
    defaults:
      run:
        working-directory: crates/cory/ui
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run fmt:check

      - name: Build (typecheck + bundle)
        run: npm run build

      - name: Enforce bundle budgets
        run: |
          set -euo pipefail
          main_js="$(ls -1 dist/assets/index-*.js | head -n 1)"
          elk_js="$(ls -1 dist/assets/elk.bundled-*.js | head -n 1)"
          main_size="$(wc -c < "${main_js}")"
          elk_size="$(wc -c < "${elk_js}")"
          echo "main bundle: ${main_js} (${main_size} bytes)"
          echo "elk bundle:  ${elk_js} (${elk_size} bytes)"
          test "${main_size}" -le 600000
          test "${elk_size}" -le 1500000

  test:
    name: Build & Test
    runs-on: ubuntu-24.04
    env:
      RUSTFLAGS: -D warnings
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2

      - name: Build and run tests with warnings denied
        run: cargo test --workspace --all-targets --all-features

      - name: Build release binary
        run: cargo build --release --bin cory

      - name: Verify built UI entrypoint exists
        run: test -f crates/cory/ui/dist/index.html

      - name: Verify packaged crate includes embedded UI assets
        run: |
          set -euo pipefail
          mkdir -p tmp
          cargo package -p cory --allow-dirty --list > tmp/cory-package-files.txt
          grep -Fx "ui/dist/index.html" tmp/cory-package-files.txt

  e2e:
    name: E2E (regtest + Playwright)
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Install Bitcoin Core binaries (bitcoind + bitcoin-cli)
        env:
          BITCOIN_VERSION: "30.2"
        run: |
          set -euo pipefail
          arch="x86_64-linux-gnu"
          tarball="bitcoin-${BITCOIN_VERSION}-${arch}.tar.gz"
          base_url="https://bitcoincore.org/bin/bitcoin-core-${BITCOIN_VERSION}"
          curl -fsSLO "${base_url}/${tarball}"
          mkdir -p "$HOME/.local/bin"
          tar -xzf "${tarball}"
          install -m 0755 "bitcoin-${BITCOIN_VERSION}/bin/bitcoind" "$HOME/.local/bin/bitcoind"
          install -m 0755 "bitcoin-${BITCOIN_VERSION}/bin/bitcoin-cli" "$HOME/.local/bin/bitcoin-cli"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Install Playwright and Chromium
        run: |
          pip install playwright
          python -m playwright install --with-deps chromium

      # Pre-build the cory binary so that `cargo run` inside the Python
      # scripts is a near-instant no-op. Without this, the first
      # `start_cory()` call compiles from scratch and can exceed the 90s
      # startup timeout on CI runners.
      - name: Build cory binary
        run: cargo build --bin cory

      - name: Run regtest scripts
        run: |
          set -euo pipefail
          python3 scripts/regtest/rpc_e2e.py
          python3 scripts/regtest/graph.py
          python3 scripts/regtest/server_e2e.py

      - name: Run Playwright E2E tests
        run: python3 scripts/ui/playwright/label.py

      - name: Upload cory logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cory-e2e-logs
          path: tmp/*.log
